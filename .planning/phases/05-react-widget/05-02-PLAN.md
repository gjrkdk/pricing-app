---
phase: 05-react-widget
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/widget/package.json
  - packages/widget/vite.config.ts
  - packages/widget/tsconfig.json
  - packages/widget/src/types.ts
  - packages/widget/src/index.ts
autonomous: true

must_haves:
  truths:
    - "Widget package scaffolded with Vite library mode configuration"
    - "TypeScript types define the complete public API surface"
    - "React and react-dom are peer dependencies, not bundled"
  artifacts:
    - path: "packages/widget/package.json"
      provides: "npm package config with peer deps, exports, and build scripts"
      contains: "peerDependencies"
    - path: "packages/widget/vite.config.ts"
      provides: "Vite library mode config that externalizes React"
      contains: "external"
    - path: "packages/widget/tsconfig.json"
      provides: "TypeScript config for React JSX"
      contains: "jsx"
    - path: "packages/widget/src/types.ts"
      provides: "PriceMatrixWidgetProps, ThemeProps, AddToCartEvent types"
      contains: "PriceMatrixWidgetProps"
    - path: "packages/widget/src/index.ts"
      provides: "Public API entry point"
      contains: "export"
  key_links:
    - from: "packages/widget/vite.config.ts"
      to: "packages/widget/src/index.ts"
      via: "lib.entry points to src/index.ts"
      pattern: "entry.*index"
    - from: "packages/widget/package.json"
      to: "packages/widget/vite.config.ts"
      via: "build script uses vite build"
      pattern: "vite build"
---

<objective>
Scaffold the widget npm package with build tooling, TypeScript configuration, and public API types.

Purpose: Establish the packages/widget/ directory with all infrastructure needed before writing components. This includes Vite library mode (ESM + UMD builds), TypeScript declarations via vite-plugin-dts, peer dependency config for React 18, and the complete type definitions that define the widget's developer-facing API.

Output: Buildable (empty) widget package with types and entry point
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-react-widget/05-CONTEXT.md
@.planning/phases/05-react-widget/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget package structure with build tooling</name>
  <files>packages/widget/package.json, packages/widget/vite.config.ts, packages/widget/tsconfig.json</files>
  <action>
1. Create `packages/widget/` directory.

2. Create `packages/widget/package.json`:
   ```json
   {
     "name": "@pricing-matrix/widget",
     "version": "0.1.0",
     "description": "Drop-in React widget for Shopify dimension-based pricing with live price updates and Draft Order checkout",
     "type": "module",
     "main": "./dist/price-matrix-widget.umd.js",
     "module": "./dist/price-matrix-widget.es.js",
     "types": "./dist/index.d.ts",
     "exports": {
       ".": {
         "types": "./dist/index.d.ts",
         "import": "./dist/price-matrix-widget.es.js",
         "require": "./dist/price-matrix-widget.umd.js"
       }
     },
     "files": ["dist"],
     "scripts": {
       "build": "vite build",
       "dev": "vite build --watch",
       "typecheck": "tsc --noEmit",
       "prepublishOnly": "npm run build"
     },
     "peerDependencies": {
       "react": "^18.0.0",
       "react-dom": "^18.0.0"
     },
     "dependencies": {
       "use-debounce": "^10.0.0",
       "react-shadow": "^20.0.0"
     },
     "devDependencies": {
       "@types/react": "^18.2.0",
       "@types/react-dom": "^18.2.0",
       "@vitejs/plugin-react": "^4.0.0",
       "react": "^18.2.0",
       "react-dom": "^18.2.0",
       "typescript": "^5.3.0",
       "vite": "^5.0.0",
       "vite-plugin-dts": "^3.0.0"
     },
     "keywords": ["shopify", "pricing", "widget", "react", "dimension-pricing"],
     "license": "MIT"
   }
   ```

   Note: react and react-dom are in BOTH peerDependencies and devDependencies. peerDependencies tells consumers they need React. devDependencies provides React for local development/building.

3. Create `packages/widget/vite.config.ts`:
   ```typescript
   import { defineConfig } from 'vite';
   import react from '@vitejs/plugin-react';
   import dts from 'vite-plugin-dts';
   import { resolve } from 'path';

   export default defineConfig({
     plugins: [
       react(),
       dts({
         rollupTypes: true,
         exclude: ['**/*.test.tsx', '**/*.test.ts'],
       }),
     ],
     build: {
       lib: {
         entry: resolve(__dirname, 'src/index.ts'),
         name: 'PriceMatrixWidget',
         formats: ['es', 'umd'],
         fileName: (format) => `price-matrix-widget.${format}.js`,
       },
       rollupOptions: {
         external: ['react', 'react-dom', 'react/jsx-runtime'],
         output: {
           globals: {
             react: 'React',
             'react-dom': 'ReactDOM',
             'react/jsx-runtime': 'ReactJSXRuntime',
           },
         },
       },
     },
   });
   ```

4. Create `packages/widget/tsconfig.json`:
   ```json
   {
     "compilerOptions": {
       "target": "ES2020",
       "module": "ESNext",
       "moduleResolution": "bundler",
       "jsx": "react-jsx",
       "strict": true,
       "esModuleInterop": true,
       "skipLibCheck": true,
       "forceConsistentCasingInFileNames": true,
       "declaration": true,
       "declarationMap": true,
       "sourceMap": true,
       "outDir": "./dist",
       "rootDir": "./src",
       "lib": ["ES2020", "DOM", "DOM.Iterable"]
     },
     "include": ["src/**/*"],
     "exclude": ["node_modules", "dist", "**/*.test.ts", "**/*.test.tsx"]
   }
   ```

5. Run `cd packages/widget && npm install` to install dependencies.
  </action>
  <verify>
    - `ls packages/widget/package.json packages/widget/vite.config.ts packages/widget/tsconfig.json` — all exist
    - `ls packages/widget/node_modules/use-debounce packages/widget/node_modules/react-shadow` — dependencies installed
    - `packages/widget/package.json` has `peerDependencies` with react ^18.0.0
  </verify>
  <done>Widget package directory exists with Vite library mode config, TypeScript config, and all dependencies installed. React is externalized (not bundled).</done>
</task>

<task type="auto">
  <name>Task 2: Create TypeScript types and entry point</name>
  <files>packages/widget/src/types.ts, packages/widget/src/index.ts</files>
  <action>
1. Create `packages/widget/src/` directory.

2. Create `packages/widget/src/types.ts` with the complete public API types:

   ```typescript
   /**
    * Props for the PriceMatrixWidget component.
    *
    * Required: apiUrl, apiKey, productId
    * Optional: theme, onAddToCart
    */
   export interface PriceMatrixWidgetProps {
     /** REST API base URL (e.g., "https://your-app.example.com") */
     apiUrl: string;

     /** API key for X-API-Key authentication */
     apiKey: string;

     /** Shopify product ID (numeric string or gid:// format) */
     productId: string;

     /** Optional theme customization via CSS custom properties */
     theme?: ThemeProps;

     /** Callback fired when Draft Order is successfully created */
     onAddToCart?: (event: AddToCartEvent) => void;
   }

   /**
    * Theme customization props. Each maps to a CSS custom property.
    * All optional — defaults are applied via CSS fallbacks.
    */
   export interface ThemeProps {
     /** Primary button/accent color. CSS var: --pm-primary-color. Default: #5c6ac4 */
     primaryColor?: string;
     /** Main text color. CSS var: --pm-text-color. Default: #202223 */
     textColor?: string;
     /** Border color for inputs. CSS var: --pm-border-color. Default: #c9cccf */
     borderColor?: string;
     /** Border radius for inputs and buttons. CSS var: --pm-border-radius. Default: 8px */
     borderRadius?: string;
     /** Base font size. CSS var: --pm-font-size. Default: 14px */
     fontSize?: string;
     /** Error text color. CSS var: --pm-error-color. Default: #d72c0d */
     errorColor?: string;
   }

   /**
    * Event payload when Draft Order is created.
    * Passed to onAddToCart callback.
    */
   export interface AddToCartEvent {
     /** Shopify Draft Order GID */
     draftOrderId: string;
     /** Customer-facing checkout URL */
     checkoutUrl: string;
     /** Unit price from matrix */
     price: number;
     /** Total price (unit price * quantity) */
     total: number;
     /** Dimensions used for pricing */
     dimensions: {
       width: number;
       height: number;
       unit: string;
     };
     /** Quantity ordered */
     quantity: number;
   }

   /**
    * API response shape from GET /api/v1/products/:id/price
    * Internal type — not exported to consumers.
    */
   export interface PriceApiResponse {
     price: number;
     currency: string;
     dimensions: {
       width: number;
       height: number;
       unit: string;
     };
     quantity: number;
     total: number;
     matrix: string;
     dimensionRange: {
       minWidth: number;
       maxWidth: number;
       minHeight: number;
       maxHeight: number;
     };
   }

   /**
    * API response shape from POST /api/v1/draft-orders
    * Internal type — not exported to consumers.
    */
   export interface DraftOrderApiResponse {
     draftOrderId: string;
     name: string;
     checkoutUrl: string;
     total: string;
     price: number;
     dimensions: {
       width: number;
       height: number;
       unit: string;
     };
     quantity: number;
   }

   /**
    * API error response (RFC 7807 format)
    * Internal type — not exported to consumers.
    */
   export interface ApiErrorResponse {
     type: string;
     title: string;
     status: number;
     detail: string;
     errors?: Record<string, string[]>;
   }
   ```

3. Create `packages/widget/src/index.ts` — the public API entry point:

   ```typescript
   // Public API — only export what consumers need
   // Internal components (DimensionInput, PriceDisplay, etc.) are NOT exported

   export { PriceMatrixWidget } from './PriceMatrixWidget';
   export type {
     PriceMatrixWidgetProps,
     ThemeProps,
     AddToCartEvent,
   } from './types';
   ```

   Note: This will cause a TypeScript error until PriceMatrixWidget.tsx is created in Plan 04. That's expected — the scaffold is intentionally incomplete.

4. Verify the types compile: `cd packages/widget && npx tsc --noEmit` (expected to fail with missing PriceMatrixWidget — that's OK for this task, just confirm types.ts has no errors by checking the error output).
  </action>
  <verify>
    - `ls packages/widget/src/types.ts packages/widget/src/index.ts` — both exist
    - types.ts contains PriceMatrixWidgetProps with apiUrl, apiKey, productId required props
    - types.ts contains ThemeProps with 6 optional CSS custom property fields
    - types.ts contains AddToCartEvent with draftOrderId, checkoutUrl, price, total, dimensions, quantity
    - index.ts exports PriceMatrixWidget component and public types (ThemeProps, AddToCartEvent, PriceMatrixWidgetProps)
  </verify>
  <done>TypeScript types define the complete widget API surface: 3 required props (apiUrl, apiKey, productId), optional theme prop with 6 CSS custom properties, onAddToCart callback with AddToCartEvent payload. Internal API response types defined for hooks. Entry point exports only public API.</done>
</task>

</tasks>

<verification>
1. `packages/widget/` directory exists with package.json, vite.config.ts, tsconfig.json, src/types.ts, src/index.ts
2. `packages/widget/node_modules/` has dependencies installed
3. package.json has `peerDependencies` for react ^18.0.0 and react-dom ^18.0.0
4. vite.config.ts externalizes react, react-dom, react/jsx-runtime
5. types.ts defines PriceMatrixWidgetProps with exactly 3 required props per CONTEXT.md decision
</verification>

<success_criteria>
- Widget package scaffolded with proper Vite library mode configuration
- React externalized as peer dependency (never bundled in output)
- TypeScript types match all locked decisions from CONTEXT.md (3 required props, optional theme prop, onAddToCart callback)
- Package builds ESM + UMD formats with TypeScript declarations
</success_criteria>

<output>
After completion, create `.planning/phases/05-react-widget/05-02-SUMMARY.md`
</output>
