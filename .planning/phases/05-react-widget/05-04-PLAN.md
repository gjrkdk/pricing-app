---
phase: 05-react-widget
plan: 04
type: execute
wave: 2
depends_on: ["05-03"]
files_modified:
  - packages/widget/src/PriceMatrixWidget.tsx
  - packages/widget/src/styles.ts
  - packages/widget/src/index.ts
autonomous: false

must_haves:
  truths:
    - "Widget renders inside Shadow DOM for CSS isolation"
    - "Theme prop sets CSS custom properties on the shadow root"
    - "Customer can enter dimensions, see live price, adjust quantity, and add to cart"
    - "Widget calls onAddToCart callback with Draft Order details and redirects to checkout"
    - "Package builds to ESM + UMD without bundling React"
  artifacts:
    - path: "packages/widget/src/PriceMatrixWidget.tsx"
      provides: "Main widget component with Shadow DOM, state management, and event handling"
      min_lines: 80
      contains: "root.div"
    - path: "packages/widget/src/styles.ts"
      provides: "CSS string for injection into Shadow DOM"
      contains: "pm-widget"
    - path: "packages/widget/dist/price-matrix-widget.es.js"
      provides: "ESM build output"
    - path: "packages/widget/dist/price-matrix-widget.umd.js"
      provides: "UMD build output"
    - path: "packages/widget/dist/index.d.ts"
      provides: "TypeScript declarations"
  key_links:
    - from: "packages/widget/src/PriceMatrixWidget.tsx"
      to: "packages/widget/src/hooks/usePriceFetch.ts"
      via: "imports and uses usePriceFetch hook"
      pattern: "usePriceFetch"
    - from: "packages/widget/src/PriceMatrixWidget.tsx"
      to: "packages/widget/src/hooks/useDraftOrder.ts"
      via: "imports and uses useDraftOrder hook"
      pattern: "useDraftOrder"
    - from: "packages/widget/src/PriceMatrixWidget.tsx"
      to: "react-shadow"
      via: "wraps content in Shadow DOM root"
      pattern: "react-shadow"
    - from: "packages/widget/src/index.ts"
      to: "packages/widget/src/PriceMatrixWidget.tsx"
      via: "exports PriceMatrixWidget"
      pattern: "export.*PriceMatrixWidget"
---

<objective>
Assemble the main PriceMatrixWidget component with Shadow DOM isolation, wire all hooks and components together, create the widget CSS, build the package, and verify it works.

Purpose: This is the final assembly — composing the hooks (Plan 03 Task 1) and components (Plan 03 Task 2) into the main widget that developers will use. The widget wraps everything in Shadow DOM via react-shadow, applies theming via CSS custom properties, manages the state flow between dimension inputs -> price fetch -> add to cart, and handles the checkout redirect. After assembly, build the package and verify it produces correct ESM + UMD outputs with TypeScript declarations.

Output: Complete, buildable widget package ready for npm publish
</objective>

<execution_context>
@/Users/robinkonijnendijk/.claude/get-shit-done/workflows/execute-plan.md
@/Users/robinkonijnendijk/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-react-widget/05-CONTEXT.md
@.planning/phases/05-react-widget/05-RESEARCH.md
@.planning/phases/05-react-widget/05-02-SUMMARY.md
@.planning/phases/05-react-widget/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create widget styles, main component, and build package</name>
  <files>packages/widget/src/styles.ts, packages/widget/src/PriceMatrixWidget.tsx, packages/widget/src/index.ts</files>
  <action>
1. Create `packages/widget/src/styles.ts` — a TypeScript module that exports the CSS as a string constant. This is injected into the Shadow DOM via a `<style>` tag. Using a .ts file (not .css) avoids CSS import issues in library mode.

   The CSS string should include:
   - `:host` block with all CSS custom property defaults:
     - `--pm-primary-color: #5c6ac4` (Shopify purple)
     - `--pm-text-color: #202223`
     - `--pm-border-color: #c9cccf`
     - `--pm-border-radius: 8px`
     - `--pm-font-size: 14px`
     - `--pm-error-color: #d72c0d`
   - `.pm-widget` container: font-family (system font stack), font-size, color, max-width, box-sizing
   - `.pm-dimension-input` wrapper: margin-bottom
   - `.pm-dimension-label`: font-weight, margin-bottom
   - `.pm-dimension-field-wrapper`: relative positioning for unit suffix
   - `.pm-dimension-field`: full-width input, padding, border, border-radius, font-size. On focus: border-color uses --pm-primary-color, outline
   - `.pm-dimension-field--error`: border-color uses --pm-error-color
   - `.pm-dimension-unit`: absolute positioned suffix inside input
   - `.pm-dimension-helper`: small text below input showing range
   - `.pm-dimension-error`: error text with --pm-error-color, small font
   - `.pm-price-display`: font-size 24px, font-weight bold, margin
   - `.pm-price-error`: error color text
   - `.pm-skeleton`: shimmer animation (gradient slide)
   - `@keyframes pm-shimmer`
   - `.pm-quantity`: flex layout with gap
   - `.pm-quantity-label`: font-weight
   - `.pm-quantity-btn`: fixed-size button, border, border-radius, cursor pointer. Disabled state: opacity, cursor not-allowed
   - `.pm-quantity-value`: text-align center, min-width
   - `.pm-add-to-cart`: full-width button, padding, background --pm-primary-color, color white, font-weight bold, border-radius, cursor pointer. Hover: darker shade. Disabled: opacity 0.5, cursor not-allowed
   - `.pm-add-to-cart-spinner`: CSS-only spinner (border with one transparent side, spinning animation)
   - `@keyframes pm-spin`

   Style the widget to look clean and professional. It should feel neutral enough to work on most storefronts while being customizable via the CSS custom properties.

2. Create `packages/widget/src/PriceMatrixWidget.tsx`:

   This is the main component that:
   - Wraps everything in `<root.div>` from react-shadow for CSS isolation
   - Injects the CSS string from styles.ts inside the Shadow DOM via `<style>` tag
   - Applies theme prop by setting CSS custom properties as inline styles on the root
   - Uses `usePriceFetch` hook for dimension state + price fetching
   - Uses `useDraftOrder` hook for checkout flow
   - Manages local `quantity` state (default 1)
   - Wires quantity into the price fetch (so total updates with quantity changes)
   - Client-side validation of dimensions: checks if values are numeric and within dimensionRange (min/max from API response). Shows validation errors on DimensionInput when:
     - Value is not a valid positive number
     - Value is below minimum or above maximum dimension range
   - DimensionInput components receive: label, value, onChange, unit, min, max, error
   - PriceDisplay receives: price (total, NOT unit price — per user decision "Total price only"), currency, loading, error
   - QuantitySelector receives: quantity, onChange
   - AddToCartButton receives: onClick, disabled (true when no price or creating), loading (creating state)

   Add-to-Cart flow:
   1. User clicks "Add to Cart"
   2. Call `createDraftOrder({ productId, width: Number(width), height: Number(height), quantity })`
   3. On success: call `onAddToCart` callback if provided, passing AddToCartEvent
   4. Then redirect to checkout: `window.location.href = checkoutUrl` (per user decision: "redirects to Shopify checkout")
   5. On error: show error (handled by useDraftOrder hook)

   Theme prop mapping:
   ```typescript
   const themeStyles: React.CSSProperties = {};
   if (props.theme?.primaryColor) themeStyles['--pm-primary-color' as any] = props.theme.primaryColor;
   if (props.theme?.textColor) themeStyles['--pm-text-color' as any] = props.theme.textColor;
   if (props.theme?.borderColor) themeStyles['--pm-border-color' as any] = props.theme.borderColor;
   if (props.theme?.borderRadius) themeStyles['--pm-border-radius' as any] = props.theme.borderRadius;
   if (props.theme?.fontSize) themeStyles['--pm-font-size' as any] = props.theme.fontSize;
   if (props.theme?.errorColor) themeStyles['--pm-error-color' as any] = props.theme.errorColor;
   ```

   Layout order (top to bottom):
   1. Width input (DimensionInput)
   2. Height input (DimensionInput)
   3. Quantity selector (QuantitySelector)
   4. Price display (PriceDisplay) — shows total price
   5. Add to Cart button (AddToCartButton)

3. Update `packages/widget/src/index.ts` — ensure the import path for PriceMatrixWidget matches the actual file:
   ```typescript
   export { PriceMatrixWidget } from './PriceMatrixWidget';
   export type { PriceMatrixWidgetProps, ThemeProps, AddToCartEvent } from './types';
   ```

4. Build the package:
   ```bash
   cd packages/widget && npm run build
   ```

5. Verify build output:
   - `ls packages/widget/dist/` — should contain:
     - `price-matrix-widget.es.js` (ESM build)
     - `price-matrix-widget.umd.js` (UMD build)
     - `index.d.ts` (TypeScript declarations)
   - Check that React is NOT in the bundle: `grep -c "createElement" packages/widget/dist/price-matrix-widget.es.js` should show minimal React references (only imports, not the full React source)

6. Verify package contents with `npm pack --dry-run`:
   ```bash
   cd packages/widget && npm pack --dry-run
   ```
   - Should only include dist/ files (not src/, node_modules/)
   - Total size should be reasonable (under 50KB)
  </action>
  <verify>
    - `ls packages/widget/dist/price-matrix-widget.es.js packages/widget/dist/price-matrix-widget.umd.js packages/widget/dist/index.d.ts` — all exist
    - `cd packages/widget && npm pack --dry-run` — shows only dist/ files
    - PriceMatrixWidget.tsx imports from react-shadow, uses usePriceFetch and useDraftOrder hooks
    - styles.ts exports CSS string with all --pm-* custom properties
    - No react-loading-skeleton in any file (Shadow DOM incompatible)
  </verify>
  <done>PriceMatrixWidget assembled with Shadow DOM, CSS injection, theme support, and all hooks/components wired. Package builds to ESM + UMD with TypeScript declarations. npm pack shows only dist/ files. React not bundled.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete React widget package at packages/widget/ with:
- Shadow DOM CSS isolation via react-shadow
- Dimension inputs with inline validation and range hints
- Debounced price fetching (400ms)
- Quantity selector with +/- buttons
- Add to Cart button that creates Draft Order and redirects to checkout
- CSS custom property theming
- ESM + UMD builds with TypeScript declarations

Also extended the REST API (Plan 01) with:
- Real currency code in price response (was "store-default")
- Dimension range (min/max width/height) in price response
- POST /api/v1/draft-orders endpoint for widget checkout flow
  </what-built>
  <how-to-verify>
1. **Build verification:**
   - Run `cd packages/widget && npm run build` — should complete without errors
   - Check `ls packages/widget/dist/` — should have .es.js, .umd.js, .d.ts files
   - Run `cd packages/widget && npm pack --dry-run` — should show only dist/ files, reasonable size

2. **API verification (requires dev server running):**
   - Start dev server: `shopify app dev` (from project root)
   - Test extended price response:
     ```
     curl -s -H "X-API-Key: YOUR_KEY" "http://localhost:PORT/api/v1/products/PRODUCT_ID/price?width=50&height=50" | python3 -m json.tool
     ```
     - Verify: `currency` field is "USD" (not "store-default")
     - Verify: `dimensionRange` object with minWidth, maxWidth, minHeight, maxHeight
     - Verify: `dimensions.unit` is "mm" or "cm"

   - Test Draft Order endpoint:
     ```
     curl -s -X POST -H "X-API-Key: YOUR_KEY" -H "Content-Type: application/json" \
       -d '{"productId":"PRODUCT_ID","width":50,"height":50,"quantity":1}' \
       "http://localhost:PORT/api/v1/draft-orders" | python3 -m json.tool
     ```
     - Verify: Returns draftOrderId, checkoutUrl, total, price fields

3. **TypeScript declarations:**
   - Check `cat packages/widget/dist/index.d.ts` — should export PriceMatrixWidget, PriceMatrixWidgetProps, ThemeProps, AddToCartEvent

4. **Code review of Shadow DOM:**
   - Open `packages/widget/src/PriceMatrixWidget.tsx`
   - Verify it uses `<root.div>` from react-shadow
   - Verify CSS is injected via `<style>` tag inside Shadow DOM
   - Verify theme prop maps to CSS custom properties
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues to fix</resume-signal>
</task>

</tasks>

<verification>
1. Package builds without errors: `cd packages/widget && npm run build`
2. Build output includes ESM, UMD, and .d.ts files
3. npm pack --dry-run shows only dist/ files
4. PriceMatrixWidget uses Shadow DOM (react-shadow)
5. CSS custom properties defined with defaults in :host
6. Theme prop overrides CSS custom properties
7. Price API returns currency, dimensionRange, unit
8. Draft Order endpoint creates order and returns checkout URL
</verification>

<success_criteria>
- Widget package builds to ESM + UMD with TypeScript declarations
- Shadow DOM isolates widget CSS from host page
- Theme prop customizes appearance via CSS custom properties
- Complete user flow works: enter dimensions -> see price -> adjust quantity -> add to cart -> redirect to checkout
- Package is publishable: npm pack shows clean dist/ output
- All locked decisions from CONTEXT.md implemented:
  - Text fields for dimensions (not sliders)
  - Unit from API (not developer prop)
  - Inline validation errors
  - Range hints as helper text
  - Total price only
  - 300-500ms debounce (400ms chosen)
  - Skeleton shimmer while loading
  - No price until valid inputs
  - Quantity +/- buttons
  - Disabled button until valid + price loaded
  - Spinner in button during Draft Order creation
  - Redirect to checkout on success
  - 3 required props (apiUrl, apiKey, productId)
  - CSS custom property theming with optional theme prop
  - onAddToCart callback
  - Intl.NumberFormat currency formatting
</success_criteria>

<output>
After completion, create `.planning/phases/05-react-widget/05-04-SUMMARY.md`
</output>
